// popup.js - Tam i≈ülevli popup

let currentVideoUrl = null;
let selectedFormat = null;
let videoInfo = null;
let downloadId = null;
let progressInterval = null;

// Popup a√ßƒ±ldƒ±ƒüƒ±nda
document.addEventListener('DOMContentLoaded', async () => {
    await initializePopup();
});

// Popup'ƒ± ba≈ülat
async function initializePopup() {
    try {
        // Backend baƒülantƒ±sƒ±nƒ± kontrol et
        const backendStatus = await checkBackendConnection();
        updateStatusBar(backendStatus);
        
        if (!backendStatus) {
            showError('Backend servisi √ßalƒ±≈ümƒ±yor! Python server\'ƒ±nƒ± ba≈ülatƒ±n.');
            return;
        }
        
        // Mevcut video URL'sini al
        const currentUrl = await getCurrentVideoUrl();
        if (!currentUrl || !isVideoUrl(currentUrl)) {
            showNoVideo();
            return;
        }
        
        currentVideoUrl = currentUrl;
        
        // Video bilgilerini backend'den al
        await loadVideoInfo();
        
    } catch (error) {
        console.error('Popup ba≈ülatma hatasƒ±:', error);
        showError('Bir hata olu≈ütu: ' + error.message);
    }
}

// Backend baƒülantƒ±sƒ±nƒ± kontrol et
async function checkBackendConnection() {
    try {
        const response = await browser.runtime.sendMessage({
            action: 'checkBackend'
        });
        return response.success && response.connected;
    } catch (error) {
        return false;
    }
}

// Durum √ßubuƒüunu g√ºncelle
function updateStatusBar(isConnected) {
    const statusBar = document.getElementById('status-bar');
    if (isConnected) {
        statusBar.textContent = '‚úÖ Backend servisi √ßalƒ±≈üƒ±yor';
        statusBar.className = 'status-bar status-connected';
    } else {
        statusBar.textContent = '‚ùå Backend servisi baƒülanamƒ±yor';
        statusBar.className = 'status-bar status-disconnected';
    }
}

// Mevcut video URL'sini al
async function getCurrentVideoUrl() {
    const tabs = await browser.tabs.query({ active: true, currentWindow: true });
    const tab = tabs[0];
    return tab.url;
}

// Video URL kontrol√º
function isVideoUrl(url) {
    return (
        url.includes('youtube.com/watch') ||
        url.includes('instagram.com/p/') ||
        url.includes('instagram.com/reel/') ||
        url.includes('instagram.com/tv/')
    );
}

// Video bilgilerini y√ºkle
async function loadVideoInfo() {
    try {
        showLoading();
        
        const response = await browser.runtime.sendMessage({
            action: 'getVideoInfo',
            url: currentVideoUrl
        });
        
        if (!response.success) {
            throw new Error(response.error);
        }
        
        videoInfo = response.data;
        displayVideoInfo();
        displayQualityOptions();
        
    } catch (error) {
        console.error('Video bilgisi y√ºkleme hatasƒ±:', error);
        showError('Video bilgisi y√ºklenemedi: ' + error.message);
    }
}

// Video bilgilerini g√∂ster
function displayVideoInfo() {
    const info = videoInfo.video_info;
    
    document.getElementById('video-title').textContent = info.title;
    document.getElementById('video-uploader').textContent = `üì∫ ${info.uploader}`;
    
    // S√ºreyi formatla
    const duration = formatDuration(info.duration);
    document.getElementById('video-duration').textContent = `‚è±Ô∏è ${duration}`;
    
    hideLoading();
    document.getElementById('main-content').style.display = 'block';
}

// Kalite se√ßeneklerini g√∂ster
function displayQualityOptions() {
    const container = document.getElementById('quality-options');
    container.innerHTML = '';
    
    videoInfo.formats.forEach((format, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'quality-option';
        optionDiv.dataset.formatIndex = index;
        
        const label = document.createElement('div');
        label.className = 'quality-label';
        label.textContent = format.quality;
        
        const type = document.createElement('div');
        type.className = 'quality-type';
        type.textContent = format.type === 'audio' ? 'üéµ Ses' : 'üé¨ Video';
        
        optionDiv.appendChild(label);
        optionDiv.appendChild(type);
        
        // Tƒ±klama olayƒ±
        optionDiv.addEventListener('click', () => {
            selectQuality(format, optionDiv);
        });
        
        container.appendChild(optionDiv);
    });
}

// Kalite se√ßimi
function selectQuality(format, element) {
    // √ñnceki se√ßimi temizle
    document.querySelectorAll('.quality-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Yeni se√ßimi i≈üaretle
    element.classList.add('selected');
    selectedFormat = format;
    
    // ƒ∞ndirme butonunu g√ºncelle
    updateDownloadButton();
}

// ƒ∞ndirme butonunu g√ºncelle
function updateDownloadButton() {
    const downloadBtn = document.getElementById('download-btn');
    const span = downloadBtn.querySelector('span:last-child');
    
    if (selectedFormat) {
        downloadBtn.disabled = false;
        span.textContent = `${selectedFormat.quality} ƒ∞ndir`;
        downloadBtn.onclick = startDownload;
    } else {
        downloadBtn.disabled = true;
        span.textContent = 'Kalite Se√ßin';
        downloadBtn.onclick = null;
    }
}

// ƒ∞ndirmeyi ba≈ülat
async function startDownload() {
    try {
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.disabled = true;
        downloadBtn.querySelector('span:last-child').textContent = 'Ba≈ülatƒ±lƒ±yor...';
        
        const response = await browser.runtime.sendMessage({
            action: 'startDownload',
            url: currentVideoUrl,
            format_id: selectedFormat.format_id,
            quality: selectedFormat.quality
        });
        
        if (!response.success) {
            throw new Error(response.error);
        }
        
        downloadId = response.data.download_id;
        showProgressSection();
        startProgressTracking();
        
    } catch (error) {
        console.error('ƒ∞ndirme ba≈ülatma hatasƒ±:', error);
        showError('ƒ∞ndirme ba≈ülatƒ±lamadƒ±: ' + error.message);
        
        // Butonu sƒ±fƒ±rla
        const downloadBtn = document.getElementById('download-btn');
        downloadBtn.disabled = false;
        updateDownloadButton();
    }
}

// Progress takibini ba≈ülat
function startProgressTracking() {
    if (progressInterval) {
        clearInterval(progressInterval);
    }
    
    progressInterval = setInterval(async () => {
        try {
            const response = await browser.runtime.sendMessage({
                action: 'getDownloadStatus',
                download_id: downloadId
            });
            
            if (response.success) {
                updateProgress(response.data);
                
                // ƒ∞ndirme tamamlandƒ± veya hata olu≈ütu
                if (response.data.status === 'tamamlandƒ±' || response.data.status === 'hata') {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
            }
            
        } catch (error) {
            console.error('Progress alma hatasƒ±:', error);
            clearInterval(progressInterval);
            progressInterval = null;
        }
    }, 1000);
}

// Progress'i g√ºncelle
function updateProgress(data) {
    const statusElement = document.getElementById('progress-status');
    const fillElement = document.getElementById('progress-fill');
    const textElement = document.getElementById('progress-text');
    
    // Durum mesajƒ±nƒ± g√ºncelle
    let statusMessage = '';
    switch (data.status) {
        case 'ba≈ülatƒ±ldƒ±':
            statusMessage = 'üöÄ ƒ∞ndirme ba≈ülatƒ±ldƒ±...';
            break;
        case 'indiriliyor':
            statusMessage = `üì• ƒ∞ndiriliyor: ${data.filename}`;
            break;
        case 'tamamlandƒ±':
            statusMessage = `‚úÖ Tamamlandƒ±: ${data.filename}`;
            break;
        case 'hata':
            statusMessage = `‚ùå Hata: ${data.error}`;
            break;
        default:
            statusMessage = `üìä Durum: ${data.status}`;
    }
    
    statusElement.textContent = statusMessage;
    
    // Progress bar'ƒ± g√ºncelle
    const progress = Math.max(0, Math.min(100, data.progress));
    fillElement.style.width = `${progress}%`;
    textElement.textContent = `${progress.toFixed(1)}%`;
    
    // Tamamlandƒ±ƒüƒ±nda ba≈üarƒ± mesajƒ±
    if (data.status === 'tamamlandƒ±') {
        setTimeout(() => {
            window.close();
        }, 3000);
    }
}

// Progress b√∂l√ºm√ºn√º g√∂ster
function showProgressSection() {
    document.getElementById('progress-section').style.display = 'block';
    document.getElementById('download-btn').style.display = 'none';
}

// Yardƒ±mcƒ± fonksiyonlar
function showLoading() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('no-video').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showError(message) {
    hideLoading();
    const errorElement = document.getElementById('error');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('no-video').style.display = 'none';
}

function showNoVideo() {
    hideLoading();
    document.getElementById('no-video').style.display = 'block';
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('error').style.display = 'none';
}

function formatDuration(seconds) {
    if (!seconds) return 'Bilinmiyor';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }
}

// Popup kapatƒ±ldƒ±ƒüƒ±nda temizle
window.addEventListener('beforeunload', () => {
    if (progressInterval) {
        clearInterval(progressInterval);
    }
});
